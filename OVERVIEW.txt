╔══════════════════════════════════════════════════════════════════════════════╗
║                                                                              ║
║         TRADING STRATEGY DSL v1 - SYSTEM ARCHITECTURE OVERVIEW               ║
║                                                                              ║
╚══════════════════════════════════════════════════════════════════════════════╝

┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 0: USER INPUT (YAML DSL)                                              │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  strategies/fade-vwap-reclaim.yaml                                           │
│  ├─ meta: symbol, timeframe, description                                    │
│  ├─ features: [vwap, ema20, lod, volume_zscore, absorption, delta]          │
│  ├─ rules:                                                                   │
│  │  ├─ arm: "close >= 90.20 && close <= 90.40 && close > vwap"             │
│  │  ├─ trigger: "close < ema20 && close < vwap && volume > 1000000"        │
│  │  └─ invalidate.when_any: ["close > vwap", "absorption == true"]         │
│  ├─ orderPlans:                                                              │
│  │  └─ primary_bracket:                                                      │
│  │     ├─ side: sell                                                         │
│  │     ├─ entryZone: [90.10, 90.30]                                         │
│  │     ├─ qty: 100                                                           │
│  │     ├─ stopPrice: 90.45                                                  │
│  │     └─ targets: [{price: 89.60, ratio: 0.5}, {price: 89.35, ratio: 0.5}]│
│  ├─ execution: {entryTimeoutBars: 2, rthOnly: true}                         │
│  └─ risk: {maxRiskPerTrade: 50}                                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 1: SPECIFICATION (Type Definitions & Schemas)                         │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐         ┌──────────────────────────────────┐   │
│  │ spec/types.ts           │         │ spec/schema.ts                   │   │
│  ├─────────────────────────┤         ├──────────────────────────────────┤   │
│  │ Core type definitions   │         │ Zod validation schemas           │   │
│  │                         │         │                                  │   │
│  │ • Bar                   │    +    │ • StrategyDSLSchema              │   │
│  │ • FeatureValue          │         │ • FeatureDSLSchema               │   │
│  │ • FeatureDescriptor     │         │ • OrderPlanDSLSchema             │   │
│  │ • ExprNode (AST)        │         │ • validate(input) → StrategyDSL  │   │
│  │ • CompiledIR            │         │                                  │   │
│  │ • StrategyRuntimeState  │         │ Runtime: Type-safe or error      │   │
│  │ • Order, OrderPlan      │         │                                  │   │
│  │ • BrokerAdapter         │         │                                  │   │
│  └─────────────────────────┘         └──────────────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 2: COMPILER (DSL → Intermediate Representation)                       │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│ ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│ │ YAML.parse() │  │  Zod Valid.  │  │ parseExpr()  │  │ typeCheck()  │   │
│ ├──────────────┤  ├──────────────┤  ├──────────────┤  ├──────────────┤   │
│ │ YAML String  │  │ StrategyDSL  │  │ jsep AST     │  │ Validate     │   │
│ │      ↓       │  │      ↓       │  │      ↓       │  │ Identifiers  │   │
│ │    Object    │  │ Validated    │  │  ExprNode    │  │      ↓       │   │
│ └──────────────┘  └──────────────┘  └──────────────┘  └──────────────┘   │
│        │                  │                 │                  │             │
│        └──────────────────┴─────────────────┴──────────────────┘             │
│                                   │                                         │
│                                   ▼                                         │
│        ┌──────────────────────────────────────────────┐                    │
│        │ compiler/compile.ts                          │                    │
│        ├──────────────────────────────────────────────┤                    │
│        │ StrategyCompiler                             │                    │
│        │                                              │                    │
│        │ buildFeaturePlan()                           │                    │
│        │   → feature registry.topologicalSort()       │                    │
│        │   → DAG of feature dependencies              │                    │
│        │                                              │                    │
│        │ buildTransitions()                           │                    │
│        │   → IDLE→ARMED→PLACED→MANAGING→EXITED        │                    │
│        │   → Parse transitions from rules             │                    │
│        │                                              │                    │
│        │ buildOrderPlans()                            │                    │
│        │   → Expand split bracket templates           │                    │
│        │                                              │                    │
│        └──────────────────────────────────────────────┘                    │
│                                   │                                         │
└───────────────────────────────────┼─────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 3: FEATURES (Indicator Registry & Computation)                        │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────┐  ┌──────────────────┐  ┌──────────────────────┐  │
│  │ FeatureRegistry      │  │ indicators.ts    │  │ microstructure.ts    │  │
│  ├──────────────────────┤  ├──────────────────┤  ├──────────────────────┤  │
│  │ registerFeature()    │  │ • VWAP           │  │ • Delta (stub)       │  │
│  │ getFeature()         │  │ • EMA20          │  │ • Absorption (stub)  │  │
│  │ topologicalSort()    │  │ • LOD            │  │                      │  │
│  │   (DAG resolution)   │  │ • VolZScore      │  │ Compute from:        │  │
│  │                      │  │                  │  │ • Bar data           │  │
│  │ Example:             │  │ Each depends on: │  │ • History            │  │
│  │                      │  │ • volume         │  │ • Features so far    │  │
│  │ close (builtin)      │  │ • close          │  │                      │  │
│  │   ↓                  │  │ • history        │  │ Extensible:          │  │
│  │ vwap                 │  │ • time           │  │ registry.register()  │  │
│  │   ↓                  │  │                  │  │                      │  │
│  │ ema20                │  └──────────────────┘  └──────────────────────┘  │
│  │   ↓                  │                                                   │
│  │ absorption           │                                                   │
│  │ (depends on vwap)    │                                                   │
│  └──────────────────────┘                                                   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ CompiledIR Output                                                             │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  {                                                                           │
│    symbol: "NFLX",                                                           │
│    timeframe: "5m",                                                          │
│    initialState: "IDLE",                                                    │
│    featurePlan: [                        ← Topologically sorted              │
│      {name: "close", type: "builtin"},   ← Builtins first                   │
│      {name: "volume", type: "builtin"},                                     │
│      {name: "vwap", type: "indicator", compute: fn, deps: ["volume"]},     │
│      {name: "ema20", type: "indicator", compute: fn, deps: ["close"]},     │
│      ...                                                                     │
│    ],                                                                        │
│    transitions: [                        ← State machine                     │
│      {from: "IDLE", to: "ARMED", when: ExprNode, actions: [...]},          │
│      {from: "ARMED", to: "PLACED", when: ExprNode, actions: [...]},        │
│      ...                                                                     │
│    ],                                                                        │
│    orderPlans: [...],                                                        │
│    execution: {entryTimeoutBars: 2, rthOnly: true},                         │
│    risk: {maxRiskPerTrade: 50}                                              │
│  }                                                                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 4: RUNTIME (FSM Engine & Execution)                                   │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │ StrategyEngine (runtime/engine.ts)                                  │    │
│  │                                                                     │    │
│  │ State: IDLE → ARMED → PLACED → MANAGING → EXITED                   │    │
│  │                                                                     │    │
│  │ processBar(bar: Bar):                                               │    │
│  │   1. Compute features (for all in featurePlan)                      │    │
│  │      → Feature computation context                                  │    │
│  │      → evaluate indicators                                          │    │
│  │                                                                     │    │
│  │   2. Tick timers                                                    │    │
│  │      → entry_timeout countdown                                     │    │
│  │                                                                     │    │
│  │   3. Evaluate transitions (from currentState)                       │    │
│  │      → For each transition: evaluateCondition(when)                 │    │
│  │      → If true: execute transition                                  │    │
│  │         → currentState = transition.to                              │    │
│  │         → For each action: executeAction()                          │    │
│  │                                                                     │    │
│  │   4. Log state change                                               │    │
│  │      → RuntimeLog entry with bar, state, action                     │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌──────────────────────┐  ┌──────────────────┐  ┌────────────────────┐    │
│  │ runtime/eval.ts      │  │ runtime/timers   │  │ Features            │    │
│  ├──────────────────────┤  ├──────────────────┤  ├────────────────────┤    │
│  │ Safe evaluator       │  │ Timer countdown  │  │ Map<name, value>   │    │
│  │ (no eval())          │  │ startTimer()     │  │                    │    │
│  │                      │  │ tick()           │  │ close: 90.20       │    │
│  │ EvaluationContext:   │  │ hasExpired()     │  │ vwap: 90.18        │    │
│  │ • features           │  │ getRemaining()   │  │ ema20: 90.19       │    │
│  │ • builtins           │  │                  │  │ absorption: false  │    │
│  │ • functions (safe)   │  │ Example:         │  │ ...                │    │
│  │                      │  │ entry_timeout    │  │                    │    │
│  │ Safe ops:            │  │ remaining: 1     │  │                    │    │
│  │ +, -, *, /, %, ==,   │  │                  │  │                    │    │
│  │ !=, <, >, <=, >=,    │  │                  │  │                    │    │
│  │ &&, ||, !            │  │                  │  │                    │    │
│  │                      │  │                  │  │                    │    │
│  │ Whitelisted funcs:   │  │                  │  │                    │    │
│  │ in_range, clamp,     │  │                  │  │                    │    │
│  │ abs, min, max, round │  │                  │  │                    │    │
│  └──────────────────────┘  └──────────────────┘  └────────────────────┘    │
│                                                                              │
│  Actions:                                                                    │
│  • start_timer(barCount)      → start countdown                              │
│  • submit_order_plan(planId)  → broker adapter call                          │
│  • cancel_entries()           → broker adapter call                          │
│  • log(message)               → RuntimeLog entry                             │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ LAYER 5: BROKER ADAPTERS (Order Execution)                                  │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────┐                  ┌────────────────────────┐   │
│  │ BaseBrokerAdapter       │                  │ AlpacaRestAdapter      │   │
│  ├─────────────────────────┤                  ├────────────────────────┤   │
│  │ (abstract base)         │                  │ REST API (HTTP)        │   │
│  │                         │                  │                        │   │
│  │ submitOrderPlan()       │                  │ POST /v2/orders        │   │
│  │ cancelOpenEntries()     │  expandSplitBracket()                     │   │
│  │ getOpenOrders()         │                  │ {                      │   │
│  │                         │                  │   symbol: "NFLX"       │   │
│  │ Helper:                 │                  │   qty: 50              │   │
│  │ expandSplitBracket()    │  ────────┐      │   side: "sell"         │   │
│  │                         │          │      │   type: "limit"        │   │
│  │ OrderPlan (qty=100)     │          │      │   order_class:         │   │
│  │ 2 targets @ 50/50       │          │      │     "bracket"          │   │
│  │      ↓                  │          │      │   take_profit: {...}   │   │
│  │ 2 Bracket orders        │          │      │   stop_loss: {...}    │   │
│  │ (50 qty each)           │          │      │ }                      │   │
│  │                         │          │      │                        │   │
│  └─────────────────────────┘          │      │ DRY RUN: Print only    │   │
│              ▲                         │      └────────────────────────┘   │
│              │                         │                                    │
│              └─────────────────────────┘      ┌────────────────────────┐   │
│                                              │ AlpacaMcpAdapter       │   │
│                                              ├────────────────────────┤   │
│                                              │ MCP Tool Calls         │   │
│                                              │                        │   │
│                                              │ alpaca_submit_bracket_ │   │
│                                              │ order()                │   │
│                                              │                        │   │
│                                              │ alpaca_cancel_order()  │   │
│                                              │                        │   │
│                                              │ alpaca_get_open_       │   │
│                                              │ orders()               │   │
│                                              │                        │   │
│                                              │ Remote execution       │   │
│                                              │ (e.g., Claude API)     │   │
│                                              └────────────────────────┘   │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────────┐
│ FINAL OUTPUT: StrategyRuntimeState                                           │
├──────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  {                                                                           │
│    symbol: "NFLX",                                                           │
│    currentState: "MANAGING",                                                │
│    barCount: 10,                                                             │
│    currentBar: {timestamp, open, high, low, close, volume},                │
│    features: Map<name, value>,          ← VWAP, EMA20, etc.                │
│    openOrders: [Order, Order, ...],     ← Placed orders                    │
│    timers: Map<name, barsRemaining>,    ← entry_timeout: 0                 │
│    log: [                               ← Structured logs                   │
│      {timestamp, barNum, level, message, data},                            │
│      ...                                                                    │
│    ]                                                                        │
│  }                                                                           │
│                                                                              │
└──────────────────────────────────────────────────────────────────────────────┘


EXAMPLE: 10-Bar Progression
═════════════════════════════════════════════════════════════════════════════════

Bar │ Close │ VWAP │ EMA20 │ State    │ Event
────┼───────┼──────┼───────┼──────────┼─────────────────────────────────────
 1  │ 90.10 │ 90.08│ 89.95 │ IDLE     │
 2  │ 90.22 │ 90.12│ 90.10 │ ARMED    │ ✓ Arm condition met (close > vwap)
 3  │ 90.32 │ 90.16│ 90.16 │ ARMED    │ (Waiting for trigger)
 4  │ 90.30 │ 90.20│ 90.21 │ ARMED    │ (Waiting for trigger)
 5  │ 90.20 │ 90.22│ 90.23 │ PLACED   │ ✓ Trigger met, orders submitted
    │       │      │       │          │ ✓ Timer started: 2 bars
 6  │ 90.08 │ 90.20│ 90.23 │ MANAGING │ ✓ Entry filled
 7  │ 90.00 │ 90.18│ 90.20 │ MANAGING │ (Managing position)
 8  │ 89.80 │ 90.13│ 90.17 │ MANAGING │ (Managing position)
 9  │ 89.60 │ 90.08│ 90.13 │ MANAGING │ (First target hit)
10  │ 89.50 │ 90.02│ 90.07 │ MANAGING │ (Second target in range)


KEY CONCEPTS
═════════════════════════════════════════════════════════════════════════════════

Expression Evaluation (NO EVAL):
  "close < vwap && volume > 1000000"
       ↓ (jsep)
   BinaryOp(&&,
     BinaryOp(<, Identifier(close), Identifier(vwap)),
     BinaryOp(>, Identifier(volume), Literal(1000000))
   )
       ↓ (safe traverse)
   Lookup features, evaluate operators
       ↓
   Boolean result

Feature DAG (Topological Sort):
  close ─┐
         ├→ ema20 ─┐
         │         ├→ absorption
  volume ┼→ vwap ──┤
         │         ├→ emission
         └→ zscore ┘

State Machine:
  IDLE ─(arm)──→ ARMED ─(trigger)──→ PLACED ─(fill)──→ MANAGING ─(invalidate)──→ EXITED

Order Expansion:
  OrderPlan(qty=100, targets=[89.60:50%, 89.35:50%])
         ↓
  Bracket 1: entry 50 @ 90.20, TP 50 @ 89.60, SL 50 @ 90.45
  Bracket 2: entry 50 @ 90.20, TP 50 @ 89.35, SL 50 @ 90.45


PERFORMANCE PROFILE
═════════════════════════════════════════════════════════════════════════════════

Operation          │ Time    │ Notes
───────────────────┼─────────┼──────────────────────────────────
Compile strategy   │ < 10ms  │ One-time on startup
Process bar        │ < 1ms   │ Per bar (5 min intervals)
Eval condition     │ < 100μs │ Fast path
Compute indicator  │ < 500μs │ Depends on indicator complexity
Total/bar          │ < 1ms   │ Typical flow


DATA FLOW SUMMARY
═════════════════════════════════════════════════════════════════════════════════

YAML Strategy
   │
   ├─(Zod)────────→ Validated StrategyDSL
   │
   ├─(jsep)───────→ Parsed ExprNodes (AST)
   │
   ├─(typecheck)──→ Type-checked identifiers
   │
   ├─(DAG sort)───→ Feature computation order
   │
   └─(build IR)───→ CompiledIR
                      │
                      └─(Runtime)────────→ Bar stream
                                             │
                                             ├─(compute features)
                                             ├─(evaluate transitions)
                                             ├─(execute actions)
                                             ├─(submit orders)
                                             └─(log events)
                                                │
                                                └─→ StrategyRuntimeState


See README.md, ARCHITECTURE.md, and IMPLEMENTATION.md for detailed documentation.
