// Prisma Schema for Trading Strategy Management System
// PostgreSQL database with comprehensive strategy versioning, execution tracking, and order management

generator client {
  provider = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
}

// ============================================================================
// USER & ACCOUNT MANAGEMENT (Multi-tenant support)
// ============================================================================

model User {
  id                String     @id @default(cuid())
  email             String     @unique
  name              String?
  role              UserRole   @default(TRADER)

  // Relationships
  strategies        Strategy[]
  accounts          Account[]
  apiKeys           ApiKey[]
  chatSessions      ChatSession[]

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([email])
  @@map("users")
}

enum UserRole {
  ADMIN
  TRADER
  VIEWER
}

model Account {
  id                String     @id @default(cuid())
  userId            String

  // Broker account details
  broker            String     // 'tws'
  accountId         String     // TWS: DU9999999
  accountName       String?

  // Configuration
  isActive          Boolean    @default(true)
  isPaper           Boolean    @default(true)
  maxConcurrentStrategies Int  @default(10)

  // Relationships
  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  strategies        Strategy[]

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@unique([userId, broker, accountId])
  @@index([userId])
  @@index([isActive])
  @@map("accounts")
}

model ApiKey {
  id                String     @id @default(cuid())
  userId            String

  name              String
  keyHash           String     // Hashed API key
  lastUsed          DateTime?
  expiresAt         DateTime?
  isActive          Boolean    @default(true)

  user              User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  @@index([userId])
  @@index([isActive])
  @@map("api_keys")
}

// ============================================================================
// STRATEGY MANAGEMENT
// ============================================================================

model Strategy {
  id                String            @id @default(cuid())
  userId            String
  accountId         String?

  // Identity
  symbol            String
  name              String
  timeframe         String

  // Current YAML content (active version)
  yamlContent       String            @db.Text

  // Status
  status            StrategyStatus    @default(DRAFT)
  runtimeState      String?           // FSM state: IDLE, ARMED, PLACED, MANAGING, EXITED (set by orchestrator)

  // Metadata extracted from YAML
  description       String?           @db.Text
  riskPerTrade      Float?
  entryTimeoutBars  Int?
  rthOnly           Boolean?

  // Lifecycle timestamps
  activatedAt       DateTime?
  closedAt          DateTime?
  archivedAt        DateTime?

  // Close reason (for auditing)
  closeReason       String?           @db.Text

  // Soft delete
  deletedAt         DateTime?

  // Relationships
  user              User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  account           Account?          @relation(fields: [accountId], references: [id], onDelete: SetNull)
  versions          StrategyVersion[]
  executions        StrategyExecution[]
  orders            Order[]
  evaluations       StrategyEvaluation[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  // REMOVED: @@unique([userId, symbol, status, deletedAt])
  // Multiple strategies per symbol are now allowed
  @@index([userId, status])
  @@index([symbol])
  @@index([status])
  @@index([userId, accountId])
  @@map("strategies")
}

enum StrategyStatus {
  DRAFT          // Created but not yet activated
  PENDING        // Ready to be loaded by orchestrator
  ACTIVE         // Currently running
  CLOSED         // Stopped by evaluator or user
  ARCHIVED       // Invalid or deprecated
  FAILED         // Compilation/validation failed
}

// ============================================================================
// STRATEGY VERSIONING (Rollback support)
// ============================================================================

model StrategyVersion {
  id                String            @id @default(cuid())
  strategyId        String

  // Version tracking
  versionNumber     Int               // Auto-incremented per strategy
  yamlContent       String            @db.Text

  // Metadata snapshot at this version
  name              String
  timeframe         String
  description       String?           @db.Text

  // Change tracking
  changeReason      String?           @db.Text
  changedBy         String?           // User or system
  changeType        VersionChangeType

  // Validation
  isValid           Boolean           @default(true)
  compilationError  String?           @db.Text

  // Relationships
  strategy          Strategy          @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  createdAt         DateTime          @default(now())

  @@unique([strategyId, versionNumber])
  @@index([strategyId])
  @@index([createdAt])
  @@map("strategy_versions")
}

enum VersionChangeType {
  CREATED         // Initial version
  MANUAL_EDIT     // User edited
  AUTO_SWAP       // Evaluator swap
  ROLLBACK        // Rollback to previous version
  IMPORTED        // Imported from file
}

// ============================================================================
// EXECUTION HISTORY (Swap & Evaluation Tracking)
// ============================================================================

model StrategyExecution {
  id                String            @id @default(cuid())
  strategyId        String

  // Execution event
  eventType         ExecutionEventType

  // Context
  currentState      String?           // IDLE, ARMED, TRIGGERED, MANAGING
  barsProcessed     Int?
  openOrderCount    Int?

  // Swap details (if eventType = SWAP)
  oldVersionId      String?
  newVersionId      String?
  swapReason        String?           @db.Text

  // Bar data snapshot
  currentPrice      Float?
  currentVolume     BigInt?
  barTimestamp      DateTime?

  // Metadata
  metadata          Json?             // Flexible JSON for additional context

  // Operation tracking (Phase 4)
  operationId       String?           // Links to OperationQueue for idempotency
  initiatedBy       String?           // User ID or 'system'
  completedAt       DateTime?

  // Relationships
  strategy          Strategy          @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  createdAt         DateTime          @default(now())

  @@index([strategyId])
  @@index([eventType])
  @@index([createdAt])
  @@index([operationId])
  @@map("strategy_executions")
}

enum ExecutionEventType {
  ACTIVATED       // Strategy activated
  DEACTIVATED     // Strategy stopped
  SWAP            // Strategy swapped
  BAR_PROCESSED   // Bar processed (can log periodically)
  ERROR           // Execution error
  INVALIDATED     // Rule invalidation triggered
  FORCE_ENTRY     // Manual force deploy entry
}

model StrategyEvaluation {
  id                String            @id @default(cuid())
  strategyId        String

  // Evaluation request snapshot
  portfolioValue    Float?
  unrealizedPnL     Float?
  realizedPnL       Float?

  currentBar        Json?             // Bar data
  recentBars        Json?             // Recent bars for context

  // Evaluation response
  recommendation    EvaluationRecommendation
  confidence        Float             // 0-1
  reason            String            @db.Text

  // Suggested strategy (if swap recommended)
  suggestedYaml     String?           @db.Text
  suggestedName     String?
  suggestedReasoning String?          @db.Text

  // Action taken
  actionTaken       Boolean           @default(false)
  actionResult      String?           @db.Text

  // Relationships
  strategy          Strategy          @relation(fields: [strategyId], references: [id], onDelete: Cascade)

  createdAt         DateTime          @default(now())

  @@index([strategyId])
  @@index([recommendation])
  @@index([createdAt])
  @@map("strategy_evaluations")
}

enum EvaluationRecommendation {
  KEEP
  SWAP
  CLOSE
}

// ============================================================================
// ORDER & TRADE TRACKING
// ============================================================================

model Order {
  id                String            @id @default(cuid())
  strategyId        String

  // Order identity
  brokerOrderId     String?           // ID from broker (TWS)
  planId            String            // From YAML orderPlans
  symbol            String

  // Order details
  side              OrderSide
  qty               Int
  type              OrderType
  limitPrice        Float?
  stopPrice         Float?

  // Bracket order relationships
  parentOrderId     String?           // For stop/target orders
  isParent          Boolean           @default(false)

  // Status
  status            OrderStatus       @default(PENDING)
  filledQty         Int               @default(0)
  avgFillPrice      Float?

  // Timing
  submittedAt       DateTime?
  filledAt          DateTime?
  cancelledAt       DateTime?

  // Error tracking
  errorMessage      String?           @db.Text

  // Relationships
  strategy          Strategy          @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  parentOrder       Order?            @relation("OrderHierarchy", fields: [parentOrderId], references: [id], onDelete: Cascade)
  childOrders       Order[]           @relation("OrderHierarchy")
  fills             Fill[]

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([strategyId])
  @@index([brokerOrderId])
  @@index([symbol])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderSide {
  BUY
  SELL
}

enum OrderType {
  MARKET
  LIMIT
  STOP
  STOP_LIMIT
}

enum OrderStatus {
  PENDING
  SUBMITTED
  FILLED
  PARTIALLY_FILLED
  CANCELLED
  REJECTED
}

model Fill {
  id                String            @id @default(cuid())
  orderId           String

  // Fill details
  qty               Int
  price             Float
  commission        Float?

  // Timing
  filledAt          DateTime

  // Relationships
  order             Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)

  createdAt         DateTime          @default(now())

  @@index([orderId])
  @@index([filledAt])
  @@map("fills")
}

// ============================================================================
// PERFORMANCE ANALYTICS (Trade P&L)
// ============================================================================

model Trade {
  id                String            @id @default(cuid())
  strategyId        String
  symbol            String

  // Entry
  entryOrderId      String            @unique
  entryQty          Int
  entryPrice        Float
  entryTime         DateTime

  // Exit
  exitOrderId       String?           @unique
  exitQty           Int?
  exitPrice         Float?
  exitTime          DateTime?

  // P&L
  realizedPnL       Float?
  commission        Float?
  netPnL            Float?

  // Classification
  tradeType         TradeType?
  isWin             Boolean?

  // Note: No FK to Strategy to preserve history even if strategy deleted

  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  @@index([strategyId])
  @@index([symbol])
  @@index([entryTime])
  @@index([exitTime])
  @@map("trades")
}

enum TradeType {
  FULL_EXIT
  PARTIAL_EXIT
  STOP_LOSS
  TARGET_HIT
}

// ============================================================================
// SYSTEM LOGS (Optional: for debugging)
// ============================================================================

model SystemLog {
  id                String            @id @default(cuid())

  level             LogLevel
  component         String            // StrategyLifecycleManager, live-server, etc.
  message           String            @db.Text
  metadata          Json?

  // Additional context
  strategyId        String?           // Link to strategy if relevant
  orderId           String?           // Link to order if relevant

  // Error tracking
  stackTrace        String?           @db.Text
  errorCode         String?

  createdAt         DateTime          @default(now())

  @@index([level])
  @@index([component])
  @@index([createdAt])
  @@index([strategyId])
  @@index([level, createdAt])
  @@index([component, createdAt])
  @@map("system_logs")
}

enum LogLevel {
  DEBUG
  INFO
  WARN
  ERROR
}

// ============================================================================
// OPERATION QUEUE & IDEMPOTENCY (Phase 2)
// ============================================================================

model OperationQueue {
  id              String            @id @default(cuid())
  operationId     String            @unique  // UUID for idempotency
  operationType   OperationType
  targetSymbol    String?
  strategyId      String?
  status          OperationStatus
  priority        Int               @default(0)
  retryCount      Int               @default(0)
  maxRetries      Int               @default(3)
  lockedUntil     DateTime?
  lockedBy        String?           // Process ID holding lock
  payload         Json              // Operation parameters
  result          Json?             // Result for idempotent replay
  errorMessage    String?           @db.Text
  createdAt       DateTime          @default(now())
  startedAt       DateTime?
  completedAt     DateTime?

  @@index([status, priority, createdAt])
  @@index([operationId])
  @@index([targetSymbol, status])
  @@map("operation_queue")
}

enum OperationType {
  SWAP_STRATEGY
  CANCEL_ORDERS
  SUBMIT_ORDERS
  EVALUATE_STRATEGY
  CLOSE_STRATEGY
  RECONCILE_ORDERS
}

enum OperationStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED
  CANCELLED
}

// ============================================================================
// ORDER AUDIT LOG (Phase 4)
// ============================================================================

model OrderAuditLog {
  id              String            @id @default(cuid())
  orderId         String?
  brokerOrderId   String?
  strategyId      String
  eventType       OrderEventType
  oldStatus       OrderStatus?
  newStatus       OrderStatus?
  quantity        Float?
  price           Float?
  errorMessage    String?           @db.Text
  metadata        Json?
  createdAt       DateTime          @default(now())

  @@index([orderId, createdAt])
  @@index([brokerOrderId, createdAt])
  @@index([strategyId, createdAt])
  @@index([eventType])
  @@map("order_audit_log")
}

enum OrderEventType {
  SUBMITTED
  CANCELLED
  FILLED
  PARTIALLY_FILLED
  REJECTED
  RECONCILED
  ORPHANED
  MISSING
}

// ============================================================================
// STRATEGY AUDIT LOG
// ============================================================================

model StrategyAuditLog {
  id              String            @id @default(cuid())
  strategyId      String
  eventType       StrategyEventType
  oldStatus       StrategyStatus?
  newStatus       StrategyStatus?
  changedBy       String?           // userId or 'system' or 'evaluator'
  changeReason    String?           @db.Text
  metadata        Json?             // Additional context (e.g., swap details, evaluation results)
  createdAt       DateTime          @default(now())

  @@index([strategyId, createdAt])
  @@index([eventType])
  @@index([changedBy])
  @@map("strategy_audit_log")
}

enum StrategyEventType {
  CREATED
  ACTIVATED
  CLOSED
  ARCHIVED
  FAILED
  YAML_UPDATED
  ROLLED_BACK
  SWAPPED_IN      // Strategy was swapped in (became active)
  SWAPPED_OUT     // Strategy was swapped out (became closed)
  DELETED
  STATUS_CHANGED  // Generic status change
  FORCE_DEPLOYED  // Manual force deploy (bypass arm/trigger)
}

// ============================================================================
// MARKET DATA CACHE
// ============================================================================

model MarketBar {
  id          Int      @id @default(autoincrement())
  symbol      String
  timeframe   String   // "1m", "5m", "15m", "30m", "1h", "1d"
  timestamp   BigInt   // Unix milliseconds
  open        Float
  high        Float
  low         Float
  close       Float
  volume      Float
  createdAt   DateTime @default(now())

  @@unique([symbol, timeframe, timestamp])
  @@index([symbol, timeframe, timestamp])
  @@map("market_bars")
}

model Bar {
  symbol     String
  period     String
  what       String
  session    String
  barStart   DateTime @map("barstart")
  barEnd     DateTime @map("barend")
  open       Float
  high       Float
  low        Float
  close      Float
  volume     Float
  wap        Float?
  tradeCount Int?     @map("trade_count")
  ingestedAt DateTime @default(now()) @map("ingested_at")

  @@id([symbol, period, what, session, barStart])
  @@index([symbol, period, what, session, barStart(sort: Desc)])
  @@map("bars")
}

// ============================================================================
// CHAT HISTORY
// ============================================================================

model ChatSession {
  id                String        @id @default(cuid())
  userId            String

  // Session identity
  title             String        @default("New Chat")

  // Link to ACP sessions (for optional context restoration)
  gatewaySessionId  String?       // Links to localStorage acp_gateway_session_id
  agentSessionId    String?       // Links to localStorage acp_agent_session_id

  // Status
  isActive          Boolean       @default(true)

  // Metadata
  persona           String        @default("blackrock_advisor")
  messageCount      Int           @default(0)

  // Timestamps
  lastMessageAt     DateTime?

  // Soft delete
  deletedAt         DateTime?

  // Relationships
  user              User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages          ChatMessage[]

  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  @@index([userId, deletedAt])
  @@index([userId, isActive])
  @@index([lastMessageAt])
  @@index([gatewaySessionId])
  @@map("chat_sessions")
}

model ChatMessage {
  id                String        @id @default(cuid())
  chatSessionId     String

  // Message content
  role              ChatRole
  content           String        @db.Text

  // Image attachments (array of storage URLs, not base64)
  imageUrls         String[]

  // Message ordering
  sequenceNumber    Int           // Order within session for deterministic ordering

  // Relationships
  chatSession       ChatSession   @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  createdAt         DateTime      @default(now())

  @@index([chatSessionId, sequenceNumber])
  @@index([chatSessionId, createdAt])
  @@map("chat_messages")
}

enum ChatRole {
  USER
  AGENT
}

// ============================================================================
// TRADING STRATEGY TEMPLATES & ANALYSIS
// ============================================================================

model StrategyTemplate {
  id                String      @id @default(cuid())
  name              String
  description       String?     @db.Text

  // Relationships
  analyses          Analysis[]

  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  @@index([name])
  @@map("strategy_templates")
}

model Analysis {
  id                      String        @id @default(cuid())
  strategyId              String        // References StrategyTemplate
  createdAt               DateTime      @default(now())

  // Analysis details
  ticker                  String        @db.VarChar(10)
  analysisDate            DateTime      @db.Date
  dateRangeStart          DateTime      @db.Date
  dateRangeEnd            DateTime      @db.Date
  setupType               String        @db.VarChar(20)

  // Trade parameters
  entryPrice              Decimal?      @db.Decimal(10, 2)
  stopLoss                Decimal?      @db.Decimal(10, 2)
  targets                 Json?
  invalidationLevel       Decimal?      @db.Decimal(10, 2)
  invalidationCondition   String?       @db.Text
  rrRatio                 Decimal?      @db.Decimal(5, 2)

  // Quality metrics
  quality                 String?       @db.VarChar(10)
  confidence              Int?

  // Analysis content
  reasoning                String?       @db.Text
  counterArgument          String?       @db.Text
  patterns                 Json?
  marketRegime             Json?
  keyLevels                Json?
  fullResponse             Json?

  // Chart paths
  rawChartPath             String?       @db.Text
  annotatedChartPath       String?       @db.Text

  // ADD THIS:
  confluence               Json?         // Confluence validation results

  // Relationships
  strategyTemplate         StrategyTemplate @relation(fields: [strategyId], references: [id], onDelete: Cascade)
  tradeOutcomes            TradeOutcome[]

  @@index([ticker])
  @@index([createdAt])
  @@index([setupType])
  @@index([strategyId])
  @@map("analyses")
}

model TradeOutcome {
  id                String      @id @default(cuid())
  analysisId        String
  createdAt         DateTime    @default(now())

  // Outcome details
  outcome           String      @db.VarChar(20)
  actualEntry       Decimal?    @db.Decimal(10, 2)
  actualExit        Decimal?    @db.Decimal(10, 2)
  actualRr          Decimal?    @db.Decimal(5, 2)
  notes             String?     @db.Text

  // Relationships
  analysis          Analysis     @relation(fields: [analysisId], references: [id], onDelete: Cascade)

  @@index([analysisId])
  @@map("trade_outcomes")
}
